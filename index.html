<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="./style.css">

    <!-- ola -->
    <script src="https://cdn.jsdelivr.net/npm/ola"></script>

    <!-- gsap min -->
    <script src="https://assets.codepen.io/16327/gsap-latest-beta.min.js?r=3.11.5"></script>

    <!-- tween -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/20.0.0/tween.umd.js"></script>

    <!-- three -->
    <script type="importmap">{
        "imports": {
            "three": "https://threejs.org/build/three.module.js",
            "three/addons/": "https://threejs.org/examples/jsm/"
        }
    }</script><!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

    <!-- <script src="./js/libs/basis/basis_transcoder.js"></script> -->


    <style>

    </style>
</head>

<body>
    <div class="cursor-container">
        <div class="cursor">
            <svg viewBox="0 0 70 70" preserveAspectRatio="xMinYMin" xmlns="http://www.w3.org/2000/svg">
                <circle cx="35" cy="35" r="7" fill="lightgrey" />
                <g class="cursor-bigPart">
                    <circle class="point" cx="35" cy="35" r="35" fill="#EAFC52" />
                    <!-- <rect class="line-v" x="34" y="20" width="3" height="30" fill="black" /> -->
                    <!-- <rect class="line-h" x="50" y="34" width="3" height="30" transform="rotate(90 50 34)" -->
                        fill="black" />
                    <polygon points="20.5 24 36.5 48 52.5 24 36.5 34 20.5 24" fill="black" transform="rotate(90 35 35)" style=""/>
                </g>
            </svg>

        </div>

    </div>
    <div class="model-container">
        <div class="model"></div>
    </div>

    <div class="image-container">
        <div class="image"></div>
    </div>

    <div class="container">

        <div class="text-block">
            <h1>Shinobi</h1>
            <p>Crew brings people closer through fandom while giving artists new ways to engage and monetize their most
                passionate fans. Connect Spotify or Apple Music
            </p>
            <div class="block_image">
                <div class="image-box">
                    <div class="box">
                        <svg width="37" height="37" viewBox="0 0 10 10" version="1.1" xmlns="http://www.w3.org/2000/svg"
                            xmlns:xlink="http://www.w3.org/1999/xlink">
                            <circle cx="5" cy="5" r="5" fill="#EAFC52" style="" />
                        </svg>
                        <!-- <img src="https://www.fromscout.com/images/features/crewArrow.svg" alt=""> -->
                    </div>
                    <span>Connect Spotify</span>
                </div>
                <div class="image-box">
                    <div class="box">
                        <svg width="37" height="37" viewBox="0 0 10 10" version="1.1" xmlns="http://www.w3.org/2000/svg"
                            xmlns:xlink="http://www.w3.org/1999/xlink">
                            <circle cx="5" cy="5" r="5" fill="#EAFC52" style="" />
                        </svg>
                    </div>
                    <span>Connect Spotify</span>
                </div>
                <div class="image-box">
                    <div class="box">
                        <svg width="37" height="37" viewBox="0 0 10 10" version="1.1" xmlns="http://www.w3.org/2000/svg"
                            xmlns:xlink="http://www.w3.org/1999/xlink">
                            <circle cx="5" cy="5" r="5" fill="#EAFC52" style="" />
                        </svg>
                    </div>
                    <span>Connect Spotify</span>
                </div>
                <!-- <div class="image-box">
                    <div class="box">
                        <img src="https://www.fromscout.com/images/features/crewArrow.svg" alt="">
                    </div>
                    <span>Connect Spotify or Apple Music</span>
                </div> -->
            </div>

            <button>
                Подробнее </button>

        </div>

        <div class="empty-block"></div>

    </div>
</body>

<script type="module">

    import * as THREE from 'three'
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { KTX2Loader } from 'three/addons/loaders/KTX2Loader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js'

    import { MeshoptDecoder } from 'three/addons/libs/meshopt_decoder.module.js';
    import {
        OrbitControls
    } from 'three/addons/controls/OrbitControls.js';

    // import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js';
    // import { GLTFLoader } from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/GLTFLoader.js';
    // import { KTX2Loader } from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/KTX2Loader.js'
    // import { MeshoptDecoder } from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/libs/meshopt_decoder.module.js'

    // BASIC

    const model = document.querySelector(".model")
    const modelContainer = document.querySelector('.model-container')

    const fov = 45
    const aspect = model.clientWidth / model.clientHeight - 0.15
    const near = 0.1
    const far = 100

    const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);

    camera.position.z = 0;
    camera.position.y = 1
    camera.position.x = 0
    camera.rotation.y = Math.PI / 2 + Math.PI / 3

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(model.clientWidth, model.clientHeight)
    // renderer.setClearColor(0x000, 1.0);

    model.appendChild(renderer.domElement);

    let mixers = []
    let clocks = []

    let isMoving = 0
    let level = 3

    const scene = new THREE.Scene();

    const exposure = 1.8

    renderer.toneMapping = THREE.ACESFilmicToneMapping
    renderer.toneMappingExposure = exposure
    renderer.useLegacyLights = false;

    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    renderer.outputColorSpace = THREE.LinearSRGBColorSpace;


    const color = 0x322b35;
    const intensity = 1350;
    const width = 12;
    const height = 4;
    const RAlight = new THREE.RectAreaLight(color, intensity, width, height);
    RAlight.position.set(0, -4, -10);
    RAlight.rotation.x = THREE.MathUtils.degToRad(135);
    scene.add(RAlight);

    const pointLight = new THREE.DirectionalLight(0x585463, 50);
    pointLight.position.set(0, 10, -10);
    scene.add(pointLight);

    const ambientLight = new THREE.AmbientLight(0xd6d83a, 2)
    ambientLight.position.set(0, 12, -13)
    scene.add(ambientLight)


    // pointLight.intensity = 1



    const geometry = new THREE.BoxGeometry(1, 2, 4);
    const material = new THREE.MeshStandardMaterial({
        color: 0xfeedaf
    });

    const cube = new THREE.Mesh(geometry, material);

    // scene.add(cube)


    //  CUSTOM CURSOR

    const mouse = Ola({
        x: undefined,
        y: undefined
    }, 5)

    const mousePrev = {
        x: undefined,
        y: undefined
    }

    const mouseDiff = Ola({
        x: undefined,
        y: undefined
    }, 10)

    const position = Ola({ x: 0, y: 0 }, 5) // new CDN

    const cursor = document.querySelector('.cursor')
    const cursorBigPart = document.querySelector('.cursor-bigPart')

    window.addEventListener('mousemove', function (e) {

        mousePrev.x = position.x
        mousePrev.y = position.y

        position.set({ x: event.pageX, y: event.pageY })

        mouse.set({
            x: event.pageX - model.clientWidth / 2 - 1,
            y: event.pageY / model.clientHeight * 2
        })

        mouseDiff.set({ x: (event.pageX - mousePrev.x) })
        // console.log(mouseDiff.x)

        cursor.style.transform = `translate3D(${position.x}px,${position.y}px,0)`
    })

    // TEXT BLOCK and cursor animation  

    // TEXT BLOCK

    let isPlayed = 0
    let isPlaying = 0

    function modelMoving(direction) {

        let sign = undefined

        if (direction == 'right') {
            sign = 0.2
        }

        if (direction == 'left') {
            sign = -1
        }

        let tweenModel = gsap.to('.model', {
            duration: 2,
            x: () => (-1) * modelContainer.offsetWidth * 0.25 * sign,
            easy: "Power1.easyInOut",
            paused: true,
            onStart: function () {
                isPlaying = 1
            },
            onComplete: function () {
                isPlaying = 0
            }
        })

        return tweenModel
    }

    const textBlock = document.querySelector('.text-block')

    let tweenText = TweenMax.to('.text-block', {
        delay: (i) => i * 1,
        duration: 1.5,
        x: -50,
        opacity: 0,
        paused: true,
        easy: Power4.easyInOut,
        immediateRender: false
    }).progress(1)

    function clickHandler() {

        if (!isPlayed) {
            cursorBigPart.style.transform += 'rotate(135deg)'
        }

        tweenText.play()

        if (!isPlayed && !isPlaying) {

            tweenText.reverse()
            modelMoving('left').play()

            isPlayed = 1
        } else if (!isPlaying) {

            modelMoving('right').play()
            tweenText.play()

            isPlayed = 0
        }
    }

    model.addEventListener('click', clickHandler)

    // CURSOR

    function enterMouseHandler() {
        cursorBigPart.style.transform = `scale(1)`
        if (isPlayed) {
            cursorBigPart.style.transform += `rotate(135deg)`
        }
    }

    function leaveMouseHandler() {
        cursorBigPart.style.transform = `scale(0)`
    }

    model.addEventListener('mouseenter', enterMouseHandler)
    model.addEventListener('mouseleave', leaveMouseHandler)

    // DOM ELEMENT add two listnerers for enter and for leave 

    // WHEEL EVENT

    let tween = undefined

    function levelDetection(direction, sign) {

        if (level == 3 && direction == 'left') {
            level = 1
        } else if (level == 1 && direction == "right") {
            level = 3
        } else {
            level = level + (sign * 1)
        }
    }

    function groupRotate(direction) {

        let sign = undefined

        console.log('check')

        if (direction === 'left') {
            sign = 1
        }

        if (direction === 'right') {
            sign = -1
        }

        // console.log(groupNinja.rotation)

        // groupNinja.rotation.y = groupRotation.y + Math.PI 
        // groupRotation.y = groupNinja.rotation.y

        // let groupRotation = {y: 0}

        tween = new TWEEN.Tween(groupRotation, false)
            .to({ y: groupRotation.y + (omega * sign) }, 3000)
            .easing(TWEEN.Easing.Exponential.InOut)
            .onUpdate(() => {
                groupRotationRound.set({ y: groupRotation.y })
                groupNinja.rotation.y = groupRotationRound.y
                // console.log(isMoving)
            })
            .start() // Start the tween immediately.
            .onStart(() => isMoving = 1)
            .onComplete(() => {
                // groupRotation.y = groupNinja.rotation.y
                levelDetection(direction, sign)

                console.log(level)
                isMoving = 0
            })

        // TweenMax.to(groupNinja.rotation, {
        //     y: groupRotation.y + (omega * sign),
        //     duration: 3,
        //     // paused: true,
        //     easy: 'expo.easyInOut',
        //     onStart: () => isMoving = 1,
        //     onComplete: () => {
        //         groupRotation.y = groupNinja.rotation.y

        //         level = level + (sign * 1)

        //         console.log(level)
        //         isMoving = 0
        //     }
        // })
    }

    window.addEventListener('wheel', wheelHandler)

    function wheelHandler(e) {
        if (e.deltaY > 30 && e.deltaY < 50 && !isMoving) {
            groupRotate('right')
            if (isPlayed) {
                clickHandler()
            }
        } else if (e.deltaY < -30 && e.deltaY < -50 && !isMoving) {
            groupRotate('left')
            if (isPlayed) {
                clickHandler()
            }
        }
    }


    // LOAD MODEL

    // dracoLoader;
    const dracoLoader = new DRACOLoader()
    dracoLoader.setDecoderPath('/js/libs/draco/')
    // dracoLoader.setDecoderConfig( { type: 'js' } );

    // ktx2Loader
    const ktx2Loader = new KTX2Loader()
        .setTranscoderPath('./js/libs/basis/')
        .detectSupport(renderer);

    const gltfLoader = new GLTFLoader().setPath('./models/')

    gltfLoader.setKTX2Loader(ktx2Loader);
    gltfLoader.setMeshoptDecoder(MeshoptDecoder);
    gltfLoader.setDRACOLoader(dracoLoader);

    async function loadModel({ x, y, z, ry, scale, url }) {

        const gltf = await gltfLoader.loadAsync(url)
        const model = gltf.scene

        // scale and position

        model.scale.set(1 * scale, 1 * scale, 1 * scale)
        model.position.set(x, y, z)
        model.rotation.set(0, ry, 0)

        //detect size of model

        const box = new THREE.Box3().setFromObject(model);
        const size = box.getSize(new THREE.Vector3());

        console.log(box)

        const height = box.max.y - box.min.y
        const width = box.max.x = box.min.x

        // animation start

        if (gltf.animations.length) {
            loadAnimation(gltf)
        }

        return model
    }

    function loadAnimation(gltf) {

        const animations = gltf.animations

        let mixer = new THREE.AnimationMixer(gltf.scene)
        let clock = new THREE.Clock()


        const firstAction = mixer.clipAction(animations[0])

        mixers.push(mixer)
        clocks.push(clock)

        // const actions = [ firstAction ]

        firstAction.play();
    }

    const n = 3
    const rds = 3
    const omega = 2 * Math.PI / n

    function createCirclePoints() {
        let points = []

        const x = function (i) {
            return rds * Math.cos(omega * i)
        }

        const y = function (i) {
            return rds * Math.sin(omega * i)
        }

        for (let i = 0; i < n; i++) {
            points.push({
                x: x(i),
                y: y(i),
                ry: Math.PI / 2 - omega * i + Math.PI
            })
        }

        return points
    }

    const points = createCirclePoints()

    const ninjaesObject = {
        donatello: loadModel({
            x: points[0].x,
            y: 0.5,
            z: points[0].y,
            ry: points[0].ry,
            scale: 0.1,
            url: 'shogun_5.glb'
        }),
        michelangelo: loadModel({
            x: points[1].x,
            y: 0,
            z: points[1].y,
            ry: points[1].ry,
            scale: 1,
            url: 'smtv_42_p.glb'
        }),
        rafhael: loadModel({
            x: points[2].x,
            y: 0,
            z: points[2].y,
            ry: points[2].ry,
            scale: 1,
            url: 'samur_2.glb'
        })
    }

    const promises = Object.values(ninjaesObject)
    const groupNinja = new THREE.Group()

    const groupRotation = {
        y: groupNinja.rotation.y
    }

    const groupRotationRound = Ola({
        y: groupNinja.rotation.y
    }, 500)

    const ninjaes = []


    promises.forEach((promise, index) => {
        promise.then(ninja => {
            ninjaes.push({ "model": ninja, "id": index + 1 })
            groupNinja.add(ninja)
        })
    })

    scene.add(groupNinja)


    // RENDER LOOP

    function animate() {
        requestAnimationFrame(animate);

        // animation of model 

        if (mixers) {
            for (let i = 0; i < mixers.length; i++) (
                mixers[i].update(clocks[i].getDelta())
            )
        }


        //  animation of group
        if (tween) {
            tween.update()
        }

        // binding model to mouse

        for (const ninja of ninjaes) {

            console.log()

            if (!isMoving && level == ninja.id) {
                // console.log(ninja.id)
                // console.log(mouse.y)
                gsap.to(ninja.model.rotation, {
                    // y: ninja.model.rotation.y + mouseDiff.x * 10,
                    // x: mouse.y * 0.15,
                    duration: 3
                })
            }
        }

        renderer.render(scene, camera);
    };

    animate();


</script>

</html>